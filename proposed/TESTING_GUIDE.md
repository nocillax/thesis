# API Testing Guide

**Base URL:** `http://localhost:3001`

**Note:** No database! All data lives on blockchain. Admin and users authenticate with cryptographic wallet signatures.

---

## Setup Instructions

### 1. Deploy Contracts and Seed Admin

Run the deployment + seed script:

```bash
cd proposed/blockchain
npx hardhat run scripts/seed-admin.js --network quorum
```

This will:

- Deploy UserRegistry contract
- Deploy CertificateRegistry contract
- Register the first admin on blockchain with `is_admin=true`

**Default admin wallet:** `0x835eBBD937996840ECA0C39798B03b3634AB90b9`

Copy the contract addresses from output and update your backend `.env`:

```
USER_REGISTRY_ADDRESS=<UserRegistry_address>
CONTRACT_ADDRESS=<CertificateRegistry_address>
ADMIN_WALLET_ADDRESS=<admin_wallet_address>
```

---

## Important Notes

### Web3 Wallet Authentication

- **No passwords!** Users authenticate by signing messages with their Ethereum wallet
- **No database!** User data (username, email, is_admin, is_authorized) stored on blockchain
- **Admin controls registration:** Only admin can register new users via smart contract
- **Wallet options:** Users can bring their own wallet OR get one auto-generated by backend (ethers.js)

### Blockchain Architecture

- **UserRegistry:** Stores users, authorization status, admin flags
- **CertificateRegistry:** Stores certificates with versioning per student_id
- **Wallet generation:** Backend can generate wallets using ethers.js OR users bring their own
- **Smart contract enforces access:** `onlyAdmin` modifier prevents unauthorized registration

---

## 1. Wallet Login (Cryptographic Signature)

**Endpoint:** `POST /api/auth/wallet-login`

**Auth:** None

**Body:**

```json
{
  "walletAddress": "0x835eBBD937996840ECA0C39798B03b3634AB90b9",
  "message": "Login to Certificate System at 2025-11-29T12:30:00Z",
  "signature": "0x1234abcd..."
}
```

**How to get signature:**

```javascript
// Using ethers.js
const ethers = require("ethers");
const wallet = new ethers.Wallet(privateKey);
const message = `Login to Certificate System at ${new Date().toISOString()}`;
const signature = await wallet.signMessage(message);
```

**Response:**

```json
{
  "success": true,
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

**Note:** Backend verifies signature matches wallet address, queries blockchain for user data (username, is_admin, is_authorized). **Only authorized users can login** - if `is_authorized=false`, login will fail. JWT token expires after 30 minutes.

---

## 2. Register User (Admin Only)

**Endpoint:** `POST /api/blockchain/users/register`

**Auth:** Admin JWT Required (must have `is_admin=true`)

**Headers:**

```
Authorization: Bearer YOUR_TOKEN
```

**Body:**

```json
{
  "username": "john_doe",
  "email": "john@university.edu",
  "is_admin": false
}
```

**Response:**

```json
{
  "success": true,
  "message": "User registered successfully. Import private key to Rabby wallet.",
  "wallet_address": "0xABC123...",
  "private_key": "0xDEF456...",
  "username": "john_doe",
  "email": "john@university.edu",
  "is_admin": false,
  "transaction_hash": "0x5678...",
  "block_number": 123
}
```

**Note:** Backend generates a new wallet, registers on blockchain with `is_authorized=true`. Save the `private_key` and import it to Rabby wallet. **User will be able to login immediately** since they are authorized by default.

---

## 3. Get User by Wallet Address

**Endpoint:** `GET /api/blockchain/users/:wallet_address`

**Auth:** JWT Required (any authenticated user)

**Headers:**

```
Authorization: Bearer YOUR_TOKEN
```

**Example:** `GET /api/blockchain/users/0x1234...`

**Response:**

```json
{
  "wallet_address": "0x1234...",
  "username": "john_doe",
  "email": "john@university.edu",
  "registration_date": "2025-11-29T12:30:00.000Z",
  "is_authorized": true,
  "is_admin": false
}
```

**Note:** Queries blockchain UserRegistry directly. No database involved.

---

## 4. Get All Users

**Endpoint:** `GET /api/blockchain/users`

**Auth:** Admin JWT Required (must have `is_admin=true`)

**Headers:**

```
Authorization: Bearer YOUR_TOKEN
```

**Query Parameters (Optional):**

- `page` - Page number (default: return all)
- `limit` - Items per page (default: return all)
- `status` - Filter by authorization status: `authorized` or `revoked`
- `is_admin` - Filter by admin role: `true` or `false`
- `hide_revoked` - Hide revoked users: `true` or `false` (when true, only shows authorized users)

**Examples:**

```bash
# Get all users (no pagination)
GET /api/blockchain/users

# Get page 1 with 20 users per page
GET /api/blockchain/users?page=1&limit=20

# Get page 2 of active users only
GET /api/blockchain/users?page=2&limit=10&status=authorized

# Get revoked users
GET /api/blockchain/users?status=revoked

# Get only admin users
GET /api/blockchain/users?is_admin=true

# Get non-admin users who are authorized
GET /api/blockchain/users?is_admin=false&status=authorized

# Hide all revoked users (show only authorized)
GET /api/blockchain/users?hide_revoked=true

# Combine filters: page 1, admins only, hide revoked
GET /api/blockchain/users?page=1&limit=20&is_admin=true&hide_revoked=true
```

**Response (without pagination):**

```json
[
  {
    "wallet_address": "0xFE3B...",
    "username": "admin",
    "email": "admin@university.edu",
    "registration_date": "2025-11-27T01:28:41.000Z",
    "is_authorized": true,
    "is_admin": true
  },
  {
    "wallet_address": "0x1234...",
    "username": "john_doe",
    "email": "john@university.edu",
    "registration_date": "2025-11-28T10:15:30.000Z",
    "is_authorized": true,
    "is_admin": false
  }
]
```

**Response (with pagination):**

```json
{
  "data": [
    {
      "wallet_address": "0xFE3B...",
      "username": "admin",
      "email": "admin@university.edu",
      "registration_date": "2025-11-27T01:28:41.000Z",
      "is_authorized": true,
      "is_admin": true
    }
  ],
  "meta": {
    "current_page": 1,
    "total_pages": 5,
    "total_count": 95,
    "has_more": true
  }
}
```

**Note:** Returns all registered users from blockchain. Use pagination for large datasets.

---

## 5. Revoke User

**Endpoint:** `PATCH /api/blockchain/users/:wallet_address/revoke`

**Auth:** Admin JWT Required (must have `is_admin=true`)

**Headers:**

```

Authorization: Bearer YOUR_TOKEN

```

**Example:** `PATCH /api/blockchain/users/0x1234.../revoke`

**Response:**

```json
{
  "success": true,
  "message": "User revoked on blockchain",
  "wallet_address": "0x1234..."
}
```

**Note:** Sets `is_authorized=false` on blockchain. **User will be immediately unable to login** - their existing JWT remains valid until expiry (30 minutes), but any write operations will fail due to real-time blockchain authorization checks.

---

## 6. Reactivate User

**Endpoint:** `PATCH /api/blockchain/users/:wallet_address/reactivate`

**Auth:** Admin JWT Required (must have `is_admin=true`)

**Headers:**

```
Authorization: Bearer YOUR_TOKEN
```

**Example:** `PATCH /api/blockchain/users/0x1234.../reactivate`

**Response:**

```json
{
  "success": true,
  "message": "User authorization restored",
  "wallet_address": "0x1234..."
}
```

**Note:** Sets `is_authorized=true` on blockchain. **User can now login again** and perform all authorized actions including issuing certificates.

---

## 7. Grant Admin Privileges

**Endpoint:** `PATCH /api/blockchain/users/:wallet_address/grant-admin`

**Auth:** Admin JWT Required (must have `is_admin=true`)

**Headers:**

```
Authorization: Bearer YOUR_TOKEN
```

**Example:** `PATCH /api/blockchain/users/0x1234.../grant-admin`

**Response:**

```json
{
  "success": true,
  "message": "Admin privileges granted",
  "wallet_address": "0x1234..."
}
```

**Note:** Sets `is_admin=true` on blockchain. User becomes an admin and can manage other users. Will fail if user is already an admin.

---

## 8. Revoke Admin Privileges

**Endpoint:** `PATCH /api/blockchain/users/:wallet_address/revoke-admin`

**Auth:** Admin JWT Required (must have `is_admin=true`)

**Headers:**

```
Authorization: Bearer YOUR_TOKEN
```

**Example:** `PATCH /api/blockchain/users/0x1234.../revoke-admin`

**Response:**

```json
{
  "success": true,
  "message": "Admin privileges revoked",
  "wallet_address": "0x1234..."
}
```

**Note:** Sets `is_admin=false` on blockchain. User loses admin privileges but remains authorized. Cannot revoke the primary admin (contract deployer). Will fail if user is not an admin.

---

## 9. Enhanced Search (Student IDs, Certificate Hashes, Wallet Addresses)

**Endpoint:** `GET /api/blockchain/search`

**Auth:** JWT Required (any authenticated user)

**Headers:**

```
Authorization: Bearer YOUR_TOKEN
```

**Query Parameters:**

- `q` - Search query (Student ID, Certificate Hash, or Wallet Address)

**Example:**

```bash
GET /api/blockchain/search?q=22-467
```

**Response:**

```json
{
  "studentIds": ["22-46734-1", "22-46735-1", "22-46790-1"],
  "certificates": [
    {
      "cert_hash": "0xabcd1234...",
      "student_id": "21-46734-1",
      "is_active": true
    }
  ],
  "users": [
    {
      "wallet_address": "0x1234...",
      "username": "john_doe",
      "email": "john@university.edu",
      "is_authorized": true
    }
  ]
}
```

**Search Logic:**

- **Student IDs**: Substring matching (case-insensitive), returns up to 5 matches
- **Certificate Hashes**: Exact matching (case-insensitive), returns matching certificate details
- **Wallet Addresses**: Exact matching (case-insensitive), returns user details

**Notes:**

- Returns grouped results by category (studentIds, certificates, users)
- Empty categories are not displayed in the response (only categories with results are shown)
- Requires authentication (any logged-in user)
- Efficient: Only returns matching results from all three data sources

---

## 10. Get All Certificates

**Endpoint:** `GET /api/blockchain/certificates`

**Auth:** JWT Required (any authenticated user)

**Headers:**

```
Authorization: Bearer YOUR_TOKEN
```

**Query Parameters (Optional):**

- `page` - Page number (default: return all)
- `limit` - Items per page (default: return all)
- `status` - Filter by certificate status: `active` or `revoked`
- `hide_revoked` - Hide revoked certificates: `true` or `false` (when true, only shows active certificates)

**Examples:**

```bash
# Get all certificates (no pagination)
GET /api/blockchain/certificates

# Get page 1 with 20 certificates per page
GET /api/blockchain/certificates?page=1&limit=20

# Get page 2 of active certificates only
GET /api/blockchain/certificates?page=2&limit=10&status=active

# Get revoked certificates
GET /api/blockchain/certificates?status=revoked

# Hide all revoked certificates (show only active)
GET /api/blockchain/certificates?hide_revoked=true

# Combine filters: page 1, hide revoked
GET /api/blockchain/certificates?page=1&limit=20&hide_revoked=true
```

**Response (without pagination):**

```json
[
  {
    "cert_hash": "0xabcd1234...",
    "student_id": "22-46734-1",
    "version": 1,
    "student_name": "Alice Johnson",
    "degree_program": "Computer Science",
    "cgpa": 385,
    "issuing_authority": "Tech University",
    "issuer": "0x08Bd40C733...",
    "issuer_name": "admin",
    "is_revoked": false,
    "signature": "0x9abc...",
    "issuance_date": "2025-11-27T01:28:41.000Z"
  }
]
```

**Response (with pagination):**

```json
{
  "data": [
    {
      "cert_hash": "0xabcd1234...",
      "student_id": "22-46734-1",
      "version": 1,
      "student_name": "Alice Johnson",
      "degree_program": "Computer Science",
      "cgpa": 385,
      "issuing_authority": "Tech University",
      "issuer": "0x08Bd40C733...",
      "issuer_name": "admin",
      "is_revoked": false,
      "signature": "0x9abc...",
      "issuance_date": "2025-11-27T01:28:41.000Z"
    }
  ],
  "meta": {
    "current_page": 1,
    "total_pages": 8,
    "total_count": 157,
    "has_more": true
  }
}
```

**Note:** Certificates are versioned by student_id. Each student can have multiple versions (v1, v2, v3...). Use pagination for large datasets.

---

## 11. Issue Certificate

**Endpoint:** `POST /api/blockchain/certificates`

**Auth:** Authorized User JWT Required (must have `is_authorized=true` - checked in real-time from blockchain before transaction)

**Headers:**

```
Authorization: Bearer YOUR_TOKEN
```

**Body:**

```json
{
  "student_id": "22-46734-1",
  "student_name": "Alice Johnson",
  "degree_program": "Computer Science",
  "cgpa": 3.85,
  "issuing_authority": "Tech University"
}
```

**Response:**

```json
{
  "success": true,
  "student_id": "22-46734-1",
  "version": 1,
  "cert_hash": "0xabcd1234...",
  "transaction_hash": "0x5678efgh...",
  "block_number": 123,
  "signature": "0x9abc..."
}
```

**Important Notes:**

- **Authorization checked from blockchain before transaction:** Even if JWT is valid, user must be authorized at transaction time
- **No certificate_number needed!** Student ID is the unique identifier
- **Automatic versioning:** First certificate = v1, second = v2, etc.
- **Must revoke active version first:** If student has an active certificate, you must revoke it before issuing a new version
- **Only one active version:** Only one version can be active at a time per student

---

## 12. Verify Certificate

**Endpoint:** `GET /api/blockchain/certificates/verify/:cert_hash`

**Auth:** None (Public)

**Example:** `GET /api/blockchain/certificates/verify/0xabcd1234...`

**Response:**

```json
{
  "cert_hash": "0xabcd1234...",
  "certificate_number": "CERT-2025-001",
  "student_id": "STU-001",
  "student_name": "Alice Johnson",
  "degree_program": "Computer Science",
  "cgpa": 3.85,
  "issuing_authority": "Tech University",
  "issuer": "0x08Bd40C733...",
  "issuer_name": "admin",
  "is_revoked": false,
  "signature": "0x9abc...",
  "issuance_date": "2025-11-27T01:28:41.000Z"
}
```

---

## 13. Revoke Certificate

**Endpoint:** `PATCH /api/blockchain/certificates/:cert_hash/revoke`

**Auth:** Authorized User JWT Required (must have `is_authorized=true` - checked in real-time from blockchain before transaction)

**Headers:**

```
Authorization: Bearer YOUR_TOKEN
```

**Body:**

```json
{
  "reason": "Certificate issued in error"
}
```

**Example:** `PATCH /api/blockchain/certificates/0xabcd1234.../revoke`

**Response:**

```json
{
  "success": true,
  "cert_hash": "0xabcd1234...",
  "transaction_hash": "0x1111...",
  "block_number": 124
}
```

**Note:** Reason is required (1-500 characters) and will be stored on blockchain as publicly visible.

---

## 14. Reactivate Certificate

**Endpoint:** `PATCH /api/blockchain/certificates/:cert_hash/reactivate`

**Auth:** Authorized User JWT Required (must have `is_authorized=true` - checked in real-time from blockchain before transaction)

**Headers:**

```
Authorization: Bearer YOUR_TOKEN
```

**Example:** `PATCH /api/blockchain/certificates/0xabcd1234.../reactivate`

**Response:**

```json
{
  "success": true,
  "cert_hash": "0xabcd1234...",
  "transaction_hash": "0x2222...",
  "block_number": 125
}
```

---

## 15. Get Audit Logs for Certificate

**Endpoint:** `GET /api/blockchain/certificates/audit-logs?cert_hash=:cert_hash`

**Auth:** JWT Required (any authenticated user)

**Headers:**

```
Authorization: Bearer YOUR_TOKEN
```

**Example:** `GET /api/blockchain/certificates/audit-logs?cert_hash=0xabcd1234...`

**Response:**

```json
[
  {
    "action": "ISSUED",
    "cert_hash": "0xabcd1234...",
    "issuer": "0x08Bd40C733...",
    "block_number": 123,
    "transaction_hash": "0x5678...",
    "timestamp": "2025-11-27T01:28:41.000Z"
  },
  {
    "action": "REVOKED",
    "cert_hash": "0xabcd1234...",
    "revoked_by": "0x08Bd40C733...",
    "block_number": 124,
    "transaction_hash": "0x1111...",
    "timestamp": "2025-11-27T02:15:30.000Z"
  },
  {
    "action": "REACTIVATED",
    "cert_hash": "0xabcd1234...",
    "reactivated_by": "0x08Bd40C733...",
    "block_number": 125,
    "transaction_hash": "0x2222...",
    "timestamp": "2025-11-27T03:45:12.000Z"
  }
]
```

**Note:** Returns audit trail for a specific certificate sorted chronologically (oldest first). Timestamps are fetched from blockchain blocks and returned in ISO format.

---

## 15a. Get All Audit Logs (System-Wide)

**Endpoint:** `GET /api/blockchain/certificates/audit-logs`

**Auth:** JWT Required (any authenticated user)

**Headers:**

```
Authorization: Bearer YOUR_TOKEN
```

**Query Parameters (Optional):**

- `page` - Page number
- `limit` - Items per page

**Examples:**

```bash
# Get all audit logs (no pagination)
GET /api/blockchain/certificates/audit-logs

# Get page 1 with 20 logs per page
GET /api/blockchain/certificates/audit-logs?page=1&limit=20
```

**Response (without pagination):**

```json
[
  {
    "action": "ISSUED",
    "cert_hash": "0xefgh5678...",
    "student_id": "22-46735-1",
    "version": 1,
    "issuer": "0x1234...",
    "block_number": 130,
    "transaction_hash": "0x9999...",
    "timestamp": "2025-11-28T10:30:00.000Z"
  },
  {
    "action": "REVOKED",
    "cert_hash": "0xabcd1234...",
    "revoked_by": "0x08Bd40C733...",
    "block_number": 124,
    "transaction_hash": "0x1111...",
    "timestamp": "2025-11-27T02:15:30.000Z"
  },
  {
    "action": "ISSUED",
    "cert_hash": "0xabcd1234...",
    "student_id": "22-46734-1",
    "version": 1,
    "issuer": "0x08Bd40C733...",
    "block_number": 123,
    "transaction_hash": "0x5678...",
    "timestamp": "2025-11-27T01:28:41.000Z"
  }
]
```

**Response (with pagination):**

```json
{
  "data": [
    {
      "action": "ISSUED",
      "cert_hash": "0xefgh5678...",
      "student_id": "22-46735-1",
      "version": 1,
      "issuer": "0x1234...",
      "block_number": 130,
      "transaction_hash": "0x9999...",
      "timestamp": "2025-11-28T10:30:00.000Z"
    }
  ],
  "meta": {
    "current_page": 1,
    "total_pages": 5,
    "total_count": 95,
    "has_more": true
  }
}
```

**Note:** Returns ALL certificate events across the entire system sorted by timestamp (newest first). Useful for system-wide monitoring and compliance auditing. Issued events include `student_id` and `version` for context.

---

## 15b. Get User Audit Logs

**Endpoint:** `GET /api/blockchain/certificates/audit-logs/user/:wallet_address`

**Auth:** JWT Required (any authenticated user)

**Headers:**

```
Authorization: Bearer YOUR_TOKEN
```

**Query Parameters (Optional):**

- `page` - Page number
- `limit` - Items per page

**Examples:**

```bash
# Get all user logs (no pagination)
GET /api/blockchain/certificates/audit-logs/user/0x08Bd40C733...

# Get page 1 with 20 logs per page
GET /api/blockchain/certificates/audit-logs/user/0x08Bd40C733...?page=1&limit=20
```

**Response (without pagination):**

```json
[
  {
    "action": "ISSUED",
    "cert_hash": "0xefgh5678...",
    "student_id": "22-46735-1",
    "version": 1,
    "block_number": 130,
    "transaction_hash": "0x9999...",
    "timestamp": "2025-11-28T10:30:00.000Z"
  },
  {
    "action": "REVOKED",
    "cert_hash": "0xabcd1234...",
    "block_number": 124,
    "transaction_hash": "0x1111...",
    "timestamp": "2025-11-27T02:15:30.000Z"
  },
  {
    "action": "ISSUED",
    "cert_hash": "0xabcd1234...",
    "student_id": "22-46734-1",
    "version": 1,
    "block_number": 123,
    "transaction_hash": "0x5678...",
    "timestamp": "2025-11-27T01:28:41.000Z"
  }
]
```

**Response (with pagination):**

```json
{
  "data": [
    {
      "action": "ISSUED",
      "cert_hash": "0xefgh5678...",
      "student_id": "22-46735-1",
      "version": 1,
      "block_number": 130,
      "transaction_hash": "0x9999...",
      "timestamp": "2025-11-28T10:30:00.000Z"
    }
  ],
  "meta": {
    "current_page": 1,
    "total_pages": 3,
    "total_count": 47,
    "has_more": true
  }
}
```

**Note:** Returns all certificate actions performed by a specific user (issued, revoked, reactivated) sorted by timestamp (newest first). Perfect for individual accountability and activity tracking.

---

## 16. Get Active Certificate by Student ID

**Endpoint:** `GET /api/blockchain/certificates/student/:student_id/active`

**Auth:** JWT Required (any authenticated user)

**Headers:**

```
Authorization: Bearer YOUR_TOKEN
```

**Example:** `GET /api/blockchain/certificates/student/22-46734-1/active`

**Response:**

```json
{
  "cert_hash": "0xabcd1234...",
  "student_id": "22-46734-1",
  "version": 2,
  "student_name": "Alice Johnson",
  "degree_program": "Computer Science",
  "cgpa": 3.85,
  "issuing_authority": "Tech University",
  "issuer": "0x08Bd40C733...",
  "issuer_name": "john_doe",
  "is_revoked": false,
  "signature": "0x9abc...",
  "issuance_date": "2025-11-27T01:28:41.000Z"
}
```

**Note:** Returns the currently active certificate for a student. Returns 404 if no active certificate exists.

---

## 17. Get All Certificate Versions by Student ID

**Endpoint:** `GET /api/blockchain/certificates/student/:student_id/versions`

**Auth:** JWT Required (any authenticated user)

**Headers:**

```
Authorization: Bearer YOUR_TOKEN
```

**Example:** `GET /api/blockchain/certificates/student/22-46734-1/versions`

**Response:**

```json
[
  {
    "cert_hash": "0xabcd1234...",
    "student_id": "22-46734-1",
    "version": 1,
    "student_name": "Alice Johnson",
    "degree_program": "Computer Science",
    "cgpa": 3.5,
    "issuing_authority": "Tech University",
    "issuer": "0x08Bd40C733...",
    "issuer_name": "john_doe",
    "is_revoked": true,
    "signature": "0x9abc...",
    "issuance_date": "2025-11-20T01:28:41.000Z"
  },
  {
    "cert_hash": "0xefgh5678...",
    "student_id": "22-46734-1",
    "version": 2,
    "student_name": "Alice Johnson",
    "degree_program": "Computer Science",
    "cgpa": 3.85,
    "issuing_authority": "Tech University",
    "issuer": "0x08Bd40C733...",
    "issuer_name": "john_doe",
    "is_revoked": false,
    "signature": "0x1def...",
    "issuance_date": "2025-11-27T01:28:41.000Z"
  }
]
```

**Note:** Returns ALL certificate versions for a student, including revoked ones. Useful for audit trails and history tracking.

---

## 18. Sync Student Data

**Endpoint:** `GET /students/sync/:student_id`

**Auth:** JWT Required (any authenticated user)

**Headers:**

```
Authorization: Bearer YOUR_TOKEN
```

**Example:** `GET /students/sync/22-46734-1`

**Response (Success):**

```json
{
  "student_id": "22-46734-1",
  "student_name": "Alice Johnson",
  "degree": "Bachelor of Science",
  "program": "Computer Science",
  "cgpa": 3.85
}
```

**Response (Error - Credits Incomplete):**

```json
{
  "statusCode": 400,
  "message": "Student has 12 credits remaining. Cannot issue certificate.",
  "error": "Bad Request"
}
```

**Note:** Validates that `credit_remaining = 0` before allowing certificate issuance. Returns 404 if student not found in database.

---

## 19. Submit Verifier Information

**Endpoint:** `POST /verifiers/submit`

**Auth:** None (Public)

**Body:**

```json
{
  "name": "John Verifier",
  "email": "john@company.com",
  "institution": "ABC Corporation",
  "website": "https://abc.com",
  "cert_hash": "0xabcd1234..."
}
```

**Response (Success):**

```json
{
  "success": true,
  "message": "Verification recorded",
  "remaining_attempts": 2
}
```

**Response (Rate Limited):**

```json
{
  "statusCode": 429,
  "message": "Rate limit exceeded: 3 attempts on certificate 0xabcd... within 15 minutes. Try again in 60 minutes.",
  "error": "Too Many Requests"
}
```

**Response (Blocked):**

```json
{
  "statusCode": 403,
  "message": "Your IP address is blocked until 2025-12-22T10:30:00Z",
  "error": "Forbidden"
}
```

**Note:** Rate limit: 3 verifications per certificate per IP within 15 minutes. Exceeding limit results in 60-minute auto-block. Returns `remaining_attempts` in response.

---

## 20. Get Verification Logs (Admin)

**Endpoint:** `GET /verifiers/logs`

**Auth:** Admin JWT Required

**Headers:**

```
Authorization: Bearer YOUR_TOKEN
```

**Query Parameters:**

- `page` - Page number (default: 1)
- `limit` - Items per page (default: 20)

**Example:** `GET /verifiers/logs?page=1&limit=20`

**Response:**

```json
{
  "data": [
    {
      "id": 1,
      "cert_hash": "0xabcd1234...",
      "ip_address": "192.168.1.100",
      "user_agent": "Mozilla/5.0...",
      "verified_at": "2025-12-22T08:30:00.000Z",
      "verifier": {
        "id": 5,
        "name": "John Verifier",
        "email": "john@company.com",
        "institution": "ABC Corporation",
        "website": "https://abc.com"
      }
    }
  ],
  "meta": {
    "total": 150,
    "page": 1,
    "limit": 20,
    "totalPages": 8
  }
}
```

**Note:** Returns paginated verification logs with verifier details joined.

---

## 21. Get Blocked Verifiers (Admin)

**Endpoint:** `GET /verifiers/blocked`

**Auth:** Admin JWT Required

**Headers:**

```
Authorization: Bearer YOUR_TOKEN
```

**Response:**

```json
[
  {
    "id": 1,
    "ip_address": "192.168.1.100",
    "blocked_until": "2025-12-22T10:30:00.000Z",
    "reason": "Rate limit exceeded: 3 attempts on certificate 0xabcd... within 15 minutes",
    "blocked_by_wallet_address": null,
    "created_at": "2025-12-22T09:30:00.000Z"
  },
  {
    "id": 2,
    "ip_address": "10.0.0.50",
    "blocked_until": "2025-12-25T12:00:00.000Z",
    "reason": "Suspicious verification activity",
    "blocked_by_wallet_address": "0x08Bd40C733...",
    "created_at": "2025-12-22T08:00:00.000Z"
  }
]
```

**Note:** Returns only active blocks (blocked_until > now). Auto-blocks have `blocked_by_wallet_address = null`.

---

## 22. Block Verifier IP (Admin)

**Endpoint:** `POST /verifiers/block`

**Auth:** Admin JWT Required

**Headers:**

```
Authorization: Bearer YOUR_TOKEN
```

**Body:**

```json
{
  "ip_address": "192.168.1.100",
  "duration_minutes": 1440,
  "reason": "Suspicious verification activity"
}
```

**Response:**

```json
{
  "success": true,
  "message": "IP address blocked successfully",
  "blocked_until": "2025-12-23T09:30:00.000Z"
}
```

**Note:** Manual block with custom duration and reason. `blocked_by_wallet_address` set to admin's wallet.

---

## 23. Unblock Verifier IP (Admin)

**Endpoint:** `DELETE /verifiers/unblock/:ip_address`

**Auth:** Admin JWT Required

**Headers:**

```
Authorization: Bearer YOUR_TOKEN
```

**Example:** `DELETE /verifiers/unblock/192.168.1.100`

**Response:**

```json
{
  "success": true,
  "message": "IP address unblocked successfully"
}
```

**Note:** Removes block from database and clears rate limit cache for the IP.

---

## 24. Record Login Session

**Endpoint:** `POST /sessions/login`

**Auth:** JWT Required

**Headers:**

```
Authorization: Bearer YOUR_TOKEN
```

**Body:**

```json
{
  "ip_address": "192.168.1.100",
  "user_agent": "Mozilla/5.0 (X11; Linux x86_64)..."
}
```

**Response:**

```json
{
  "success": true,
  "message": "Login session recorded",
  "session": {
    "id": 1,
    "wallet_address": "0x08Bd40C733...",
    "user_name": "admin",
    "login_at": "2025-12-22T09:30:00.000Z",
    "session_status": "active"
  }
}
```

**Note:** Called automatically after successful wallet login to track admin sessions.

---

## 25. Record Logout Session

**Endpoint:** `POST /sessions/logout`

**Auth:** JWT Required

**Headers:**

```
Authorization: Bearer YOUR_TOKEN
```

**Response:**

```json
{
  "success": true,
  "message": "Logout session recorded",
  "sessions_updated": 1
}
```

**Note:** Marks all active sessions for the user as `logged_out`. Called automatically on logout.

---

## 26. Get My Sessions

**Endpoint:** `GET /sessions/my-sessions`

**Auth:** JWT Required

**Headers:**

```
Authorization: Bearer YOUR_TOKEN
```

**Query Parameters:**

- `page` - Page number (default: 1)
- `limit` - Items per page (default: 20)

**Response:**

```json
{
  "data": [
    {
      "id": 5,
      "wallet_address": "0x08Bd40C733...",
      "user_name": "admin",
      "login_at": "2025-12-22T09:30:00.000Z",
      "logout_at": "2025-12-22T11:45:00.000Z",
      "session_status": "logged_out",
      "ip_address": "192.168.1.100",
      "user_agent": "Mozilla/5.0..."
    }
  ],
  "meta": {
    "total": 47,
    "page": 1,
    "limit": 20,
    "totalPages": 3
  }
}
```

**Note:** Returns user's own session history ordered by login_at descending.

---

## 27. Get Offline Periods

**Endpoint:** `GET /sessions/offline-periods`

**Auth:** JWT Required

**Headers:**

```
Authorization: Bearer YOUR_TOKEN
```

**Query Parameters:**

- `start_date` - Filter from date (ISO format, optional)
- `end_date` - Filter to date (ISO format, optional)

**Example:** `GET /sessions/offline-periods?start_date=2025-12-01&end_date=2025-12-22`

**Response:**

```json
[
  {
    "offline_start": "2025-12-22T11:45:00.000Z",
    "offline_end": "2025-12-22T14:30:00.000Z",
    "duration_minutes": 165
  },
  {
    "offline_start": "2025-12-21T18:00:00.000Z",
    "offline_end": "2025-12-22T09:30:00.000Z",
    "duration_minutes": 930
  }
]
```

**Note:** Calculates gaps between logout and next login. Useful for tracking admin availability.

---

## 28. Get Session Statistics

**Endpoint:** `GET /sessions/stats`

**Auth:** JWT Required

**Headers:**

```
Authorization: Bearer YOUR_TOKEN
```

**Response:**

```json
{
  "total_sessions": 47,
  "active_sessions": 1,
  "logged_out_sessions": 40,
  "expired_sessions": 6,
  "average_session_duration_minutes": 135
}
```

**Note:** Aggregated statistics for user's sessions.

---

## 29. Get Active Session

**Endpoint:** `GET /sessions/active`

**Auth:** JWT Required

**Headers:**

```
Authorization: Bearer YOUR_TOKEN
```

**Response:**

```json
{
  "id": 5,
  "wallet_address": "0x08Bd40C733...",
  "user_name": "admin",
  "login_at": "2025-12-22T09:30:00.000Z",
  "session_status": "active",
  "ip_address": "192.168.1.100",
  "user_agent": "Mozilla/5.0..."
}
```

**Note:** Returns currently active session or 404 if none active.

---

## 30. Get Offline Activities

**Endpoint:** `GET /offline-activities`

**Auth:** JWT Required

**Headers:**

```
Authorization: Bearer YOUR_TOKEN
```

**Query Parameters:**

- `start_date` - Filter from date (ISO format, optional)
- `end_date` - Filter to date (ISO format, optional)

**Example:** `GET /offline-activities?start_date=2025-12-01`

**Response:**

```json
[
  {
    "offline_period": {
      "offline_start": "2025-12-22T11:45:00.000Z",
      "offline_end": "2025-12-22T14:30:00.000Z",
      "duration_minutes": 165
    },
    "events": [
      {
        "action": "ISSUED",
        "cert_hash": "0xabcd1234...",
        "student_id": "22-46734-1",
        "version": 1,
        "timestamp": "2025-12-22T12:30:00.000Z",
        "block_number": 123,
        "transaction_hash": "0x5678..."
      },
      {
        "action": "REVOKED",
        "cert_hash": "0xefgh5678...",
        "timestamp": "2025-12-22T13:15:00.000Z",
        "block_number": 125,
        "transaction_hash": "0x9abc..."
      }
    ]
  }
]
```

**Note:** Shows blockchain events that occurred during admin's offline periods.

---

## 31. Get Missed Activities Count

**Endpoint:** `GET /offline-activities/count`

**Auth:** JWT Required

**Headers:**

```
Authorization: Bearer YOUR_TOKEN
```

**Response:**

```json
{
  "count": 12
}
```

**Note:** Total number of blockchain events during all offline periods.

---

## 32. Download Certificate PDF

**Endpoint:** `GET /api/blockchain/certificates/:hash/download`

**Auth:** JWT Required

**Headers:**

```
Authorization: Bearer YOUR_TOKEN
```

**Example:** `GET /api/blockchain/certificates/0xabcd1234.../download`

**Response:** PDF file download with QR code embedded

**Note:** Generates certificate PDF with 75x75px QR code at bottom-center containing certificate hash.

---

## 33. Preview Certificate PNG

**Endpoint:** `GET /api/blockchain/certificates/:hash/preview`

**Auth:** JWT Required

**Headers:**

```
Authorization: Bearer YOUR_TOKEN
```

**Example:** `GET /api/blockchain/certificates/0xabcd1234.../preview`

**Response:** PNG image with QR code embedded

**Note:** Generates certificate preview PNG with 75x75px QR code at bottom-center containing certificate hash.

---

## 34. Get Revoke Reason

**Endpoint:** `GET /api/blockchain/certificates/:hash/revoke-reason`

**Auth:** JWT Required

**Headers:**

```
Authorization: Bearer YOUR_TOKEN
```

**Example:** `GET /api/blockchain/certificates/0xabcd1234.../revoke-reason`

**Response:**

```json
{
  "cert_hash": "0xabcd1234...",
  "reason": "Certificate issued in error",
  "revoked_by": "0x08Bd40C733...",
  "revoked_by_name": "admin",
  "timestamp": "2025-12-22T10:30:00.000Z",
  "block_number": 125
}
```

**Note:** Fetches revoke reason from blockchain CertificateRevoked event. Returns 404 if certificate not revoked.

---

## Contract Addresses

Update these after running `seed-admin.js`:

```
CertificateRegistry: 0xa1dc9167B1a8F201d15b48BdD5D77f8360845ceD
UserRegistry: 0xECB550dE5c73e6690AB4521C03EC9D476617167E
Admin Wallet: 0xFE3B557E8Fb62b89F4916B721be55cEb828dBd73
```

**Note:** All users (including admin) authenticate via cryptographic wallet signatures. No passwords, no database. **JWT tokens expire after 30 minutes** - users must re-login by signing a new message. **Only authorized users (`is_authorized=true`) can login** - unauthorized users will be rejected during the login process.

**Authorization Model:**

- **Login**: Only authorized users can obtain JWT tokens
- **Read operations**: JWT authentication only (fast)
- **Write operations**: JWT + real-time blockchain authorization check (secure)
- **Public endpoints**: Certificate verification is publicly accessible without authentication

**Important:** When issuing certificates, the authenticated user's wallet address (from JWT) is recorded as the issuer, while the admin wallet pays for gas fees. This allows tracking individual issuers without funding multiple wallets.
